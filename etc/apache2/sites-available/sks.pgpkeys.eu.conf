<VirtualHost *:80 *:11371>
	ServerName sks.pgpkeys.eu
	ServerAdmin andrewg@pgpkeys.eu
	DocumentRoot /var/www/pgpkeyserver-lite

	ErrorLog ${APACHE_LOG_DIR}/sks.pgpkeys.eu-error.log
	CustomLog ${APACHE_LOG_DIR}/sks.pgpkeys.eu-access.log combined

        # List your secondary ports here
        <Proxy balancer://secondaries>
                BalancerMember http://127.0.0.1:21371 ping=500ms ttl=5
                BalancerMember http://127.0.0.1:22371 ping=500ms ttl=5
                BalancerMember http://127.0.0.1:23371 ping=500ms ttl=5
                BalancerMember http://127.0.0.1:24371 ping=500ms ttl=5
        </Proxy>
        RewriteEngine on
        RewriteRule ^/stats balancer://secondaries/pks/lookup?op=stats [P]
        RewriteRule ^/s/(.*) balancer://secondaries/pks/lookup?search=$1 [P]
        RewriteRule ^/search/(.*) balancer://secondaries/pks/lookup?search=$1 [P]
        RewriteRule ^/g/(.*) balancer://secondaries/pks/lookup?op=get&search=$1 [P]
        RewriteRule ^/get/(.*) balancer://secondaries/pks/lookup?op=get&search=$1 [P]
        RewriteRule ^/d/(.*) balancer://secondaries/pks/lookup?op=get&options=mr&search=$1 [P]
        RewriteRule ^/download/(.*) balancer://secondaries/pks/lookup?op=get&options=mr&search=$1 [P]
        RewriteRule ^/pks/(.*) balancer://secondaries/pks/$1 [P]

        # Need this to be recognised as a reverse proxy by the sks pool
        ProxyVia On
</VirtualHost>

<VirtualHost *:443>
	ServerName sks.pgpkeys.eu
	ServerAdmin andrewg@pgpkeys.eu
	DocumentRoot /var/www/pgpkeyserver-lite

	ErrorLog ${APACHE_LOG_DIR}/sks.pgpkeys.eu.ssl-error.log
	CustomLog ${APACHE_LOG_DIR}/sks.pgpkeys.eu.ssl-access.log combined

	SSLEngine on
	SSLStrictSNIVHostCheck off
	SSLCertificateFile /etc/letsencrypt/live/sks.pgpkeys.eu/fullchain.pem
	SSLCertificateKeyFile /etc/letsencrypt/live/sks.pgpkeys.eu/privkey.pem
	SSLCACertificateFile /etc/letsencrypt/live/sks.pgpkeys.eu/chain.pem

	<Directory /var/www/html>
		Options -Indexes
		AllowOverride None
		Require all granted
	</Directory>

        # List your secondary ports here
        <Proxy balancer://secondaries>
                BalancerMember http://127.0.0.1:21371 ping=500ms ttl=5
                BalancerMember http://127.0.0.1:22371 ping=500ms ttl=5
                BalancerMember http://127.0.0.1:23371 ping=500ms ttl=5
                BalancerMember http://127.0.0.1:24371 ping=500ms ttl=5
        </Proxy>
        RewriteEngine on
        RewriteRule ^/stats balancer://secondaries/pks/lookup?op=stats [P]
        RewriteRule ^/s/(.*) balancer://secondaries/pks/lookup?search=$1 [P]
        RewriteRule ^/search/(.*) balancer://secondaries/pks/lookup?search=$1 [P]
        RewriteRule ^/g/(.*) balancer://secondaries/pks/lookup?op=get&search=$1 [P]
        RewriteRule ^/get/(.*) balancer://secondaries/pks/lookup?op=get&search=$1 [P]
        RewriteRule ^/d/(.*) balancer://secondaries/pks/lookup?op=get&options=mr&search=$1 [P]
        RewriteRule ^/download/(.*) balancer://secondaries/pks/lookup?op=get&options=mr&search=$1 [P]
        RewriteRule ^/pks/(.*) balancer://secondaries/pks/$1 [P]

        # Need this to be recognised as a reverse proxy by the sks pool
        ProxyVia On
</VirtualHost>
